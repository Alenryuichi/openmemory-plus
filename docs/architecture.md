# OpenMemory Plus 架构设计

## 概述

OpenMemory Plus 是一个双层记忆管理框架，整合项目级和用户级记忆系统。

## 架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    OpenMemory Plus                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐     │
│  │   /memory   │    │  /mem xxx   │    │  自动提取   │     │
│  │   (入口)    │    │  (子命令)   │    │  (Skill)    │     │
│  └──────┬──────┘    └──────┬──────┘    └──────┬──────┘     │
│         │                  │                  │             │
│         └──────────────────┼──────────────────┘             │
│                            ↓                                │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              Memory Router (分类路由)                │   │
│  │                                                      │   │
│  │  规则: rules/classification.md                       │   │
│  │  ├── 项目配置 → .memory/                            │   │
│  │  ├── 技术决策 → .memory/                            │   │
│  │  ├── 用户偏好 → openmemory                          │   │
│  │  └── 用户技能 → openmemory                          │   │
│  └─────────────────────────────────────────────────────┘   │
│                            │                                │
│         ┌──────────────────┼──────────────────┐            │
│         ↓                                     ↓            │
│  ┌─────────────────┐              ┌─────────────────┐      │
│  │   .memory/      │              │   openmemory    │      │
│  │   (项目级)      │              │   (用户级)      │      │
│  ├─────────────────┤              ├─────────────────┤      │
│  │ project.yaml    │              │ Qdrant Vector   │      │
│  │ decisions.yaml  │              │ BGE-M3 Embed    │      │
│  │ changelog.yaml  │              │ DeepSeek LLM    │      │
│  ├─────────────────┤              ├─────────────────┤      │
│  │ Git 版本控制    │              │ MCP 协议        │      │
│  │ YAML 格式       │              │ 语义搜索        │      │
│  └─────────────────┘              └─────────────────┘      │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 组件说明

### 1. 命令层 (Commands)

| 组件 | 职责 |
|------|------|
| `/memory` | 统一入口，快速状态，子命令路由 |
| `/mem status` | 显示两层记忆状态 |
| `/mem search` | 并行搜索两层记忆 |
| `/mem sync` | 检测并解决冲突 |
| `/mem clean` | 清理 ROT 记忆 |
| `/mem extract` | 手动触发提取 |

### 2. 路由层 (Router)

**分类规则** (`rules/classification.md`):

- 基于关键词检测
- 基于信息类型判断
- 支持自定义规则扩展

### 3. 存储层 (Storage)

#### 项目级 (.memory/)

- **格式**: YAML
- **版本控制**: Git
- **生命周期**: 跟随项目
- **访问方式**: 文件系统

#### 用户级 (openmemory)

- **格式**: 向量 + 文本
- **存储**: Qdrant
- **生命周期**: 永久
- **访问方式**: MCP 协议

## 数据流

### 写入流程

```
用户输入/Agent 检测
        ↓
    信息提取
        ↓
    分类判断
        ↓
   ┌────┴────┐
   ↓         ↓
.memory/  openmemory
```

### 读取流程

```
查询请求
    ↓
并行查询
    ↓
┌───┴───┐
↓       ↓
grep   语义搜索
↓       ↓
└───┬───┘
    ↓
结果融合
    ↓
返回结果
```

## 扩展点

1. **自定义分类规则**: 修改 `rules/classification.md`
2. **新增命令**: 在 `commands/` 添加 `mem-xxx.md`
3. **新增 Skill**: 在 `skills/` 添加目录
4. **存储后端**: 可替换 Qdrant 为其他向量库

