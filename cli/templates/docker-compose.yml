# OpenMemory Plus - Docker Compose Configuration
# ä¸€é”®å¯åŠ¨æ‰€æœ‰ä¾èµ–æœåŠ¡ (Qdrant + Ollama)
#
# ä½¿ç”¨æ–¹æ³•:
#   å¯åŠ¨æœåŠ¡: docker compose up -d
#   åœæ­¢æœåŠ¡: docker compose down
#   æŸ¥çœ‹æ—¥å¿—: docker compose logs -f
#   æŸ¥çœ‹çŠ¶æ€: docker compose ps
#
# æˆ–ä½¿ç”¨ CLI:
#   omp deps up
#   omp deps down
#   omp deps status

version: '3.8'

services:
  # Qdrant å‘é‡æ•°æ®åº“
  # ç”¨äºå­˜å‚¨ç”¨æˆ·è®°å¿†çš„å‘é‡è¡¨ç¤º
  qdrant:
    image: qdrant/qdrant:latest
    container_name: openmemory-qdrant
    ports:
      - "6333:6333"   # REST API
      - "6334:6334"   # gRPC API
    volumes:
      - qdrant_data:/qdrant/storage
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/readyz"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # Ollama - æœ¬åœ° LLM è¿è¡Œæ—¶
  # ç”¨äºè¿è¡Œ BGE-M3 åµŒå…¥æ¨¡å‹
  ollama:
    image: ollama/ollama:latest
    container_name: openmemory-ollama
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11434/api/tags"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # BGE-M3 æ¨¡å‹åˆå§‹åŒ–å™¨
  # é¦–æ¬¡å¯åŠ¨æ—¶è‡ªåŠ¨ä¸‹è½½ BGE-M3 æ¨¡å‹
  bge-m3-init:
    image: ollama/ollama:latest
    container_name: openmemory-bge-init
    depends_on:
      ollama:
        condition: service_healthy
    volumes:
      - ollama_data:/root/.ollama
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        echo "ğŸ”„ æ£€æŸ¥ BGE-M3 æ¨¡å‹..."
        if ollama list | grep -q "bge-m3"; then
          echo "âœ… BGE-M3 æ¨¡å‹å·²å­˜åœ¨"
        else
          echo "ğŸ“¥ ä¸‹è½½ BGE-M3 æ¨¡å‹ (çº¦ 1.2GB)..."
          OLLAMA_HOST=http://ollama:11434 ollama pull bge-m3
          echo "âœ… BGE-M3 æ¨¡å‹ä¸‹è½½å®Œæˆ"
        fi
    restart: "no"

volumes:
  qdrant_data:
    name: openmemory-qdrant-data
  ollama_data:
    name: openmemory-ollama-data

networks:
  default:
    name: openmemory-network

